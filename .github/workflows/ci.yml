name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Run Rust tests
        run: cargo test --all-features

  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  rust-fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --check

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Create venv and install dependencies
        run: |
          uv venv
          uv pip install ruff

      - name: Run ruff check
        run: uv run ruff check python/ tests/

      - name: Run ruff format check
        run: uv run ruff format --check python/ tests/

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Create venv and install dependencies
        run: |
          uv venv
          uv pip install mypy numpy pandas scipy

      - name: Run mypy type check
        run: uv run mypy python/ --ignore-missing-imports

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Create venv and build
        run: |
          uv venv
          uv pip install maturin pytest pytest-cov pandas polars

      - name: Build package
        uses: PyO3/maturin-action@v1
        with:
          command: develop
          args: --release
          sccache: true
        env:
          VIRTUAL_ENV: ${{ github.workspace }}/.venv

      - name: Run tests with coverage
        run: uv run pytest tests/ -v --cov=mixedlm --cov-report=xml --ignore=tests/test_property.py --ignore=tests/test_benchmark.py

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        if: matrix.python-version == '3.12'
        with:
          files: coverage.xml
          fail_ci_if_error: false

  test-free-threaded:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13t (free-threaded)
        uses: actions/setup-python@v6
        with:
          python-version: "3.13t"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Create venv and install dependencies
        run: |
          python -m venv .venv
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install maturin pytest pandas

      - name: Build package (free-threaded)
        uses: PyO3/maturin-action@v1
        with:
          command: develop
          args: --release
        env:
          VIRTUAL_ENV: ${{ github.workspace }}/.venv

      - name: Run tests
        run: .venv/bin/python -m pytest tests/ -v --ignore=tests/test_property.py --ignore=tests/test_benchmark.py

  rust-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Generate coverage
        run: cargo llvm-cov --all-features --lcov --output-path lcov.info

      - name: Upload Rust coverage
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          fail_ci_if_error: false

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo audit
        run: cargo audit

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Run pip-audit
        run: |
          uv venv
          uv pip install pip-audit
          uv pip compile pyproject.toml -o requirements.txt
          uv run pip-audit -r requirements.txt

  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Install docs dependencies
        run: |
          uv venv
          uv pip install mkdocs mkdocs-material pymdown-extensions

      - name: Build docs
        run: uv run mkdocs build --strict

  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install dependencies
        run: |
          uv venv
          uv pip install maturin pytest pytest-benchmark pandas

      - name: Build package
        uses: PyO3/maturin-action@v1
        with:
          command: develop
          args: --release
          sccache: true
        env:
          VIRTUAL_ENV: ${{ github.workspace }}/.venv

      - name: Run benchmarks
        run: uv run pytest tests/ -v --benchmark-only --benchmark-json=benchmark.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results
          path: benchmark.json
        if: always()

  msrv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Rust (MSRV)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Check MSRV
        run: cargo check --all-features

  miri:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: miri

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Run Miri
        run: cargo miri test --lib
        env:
          MIRIFLAGS: "-Zmiri-disable-isolation -Zmiri-permissive-provenance"

  property-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install dependencies
        run: |
          uv venv
          uv pip install maturin pytest hypothesis pandas numpy

      - name: Build package
        uses: PyO3/maturin-action@v1
        with:
          command: develop
          args: --release
          sccache: true
        env:
          VIRTUAL_ENV: ${{ github.workspace }}/.venv

      - name: Run property-based tests
        run: uv run pytest tests/test_property.py -v

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: "2_28"
            rustflags: "-C target-cpu=x86-64-v3"
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            manylinux: "2_28"
            rustflags: ""
          - os: macos-14
            target: aarch64-apple-darwin
            rustflags: ""
          - os: macos-15-intel
            target: x86_64-apple-darwin
            rustflags: "-C target-cpu=x86-64-v3"
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            rustflags: "-C target-cpu=x86-64-v3"
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist
          manylinux: ${{ matrix.manylinux || 'auto' }}
          sccache: true
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}

      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-${{ matrix.target }}
          path: dist/*.whl

  build-free-threaded:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: "2_28"
          - os: macos-14
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13t
        uses: actions/setup-python@v6
        with:
          python-version: "3.13t"

      - name: Build wheels (free-threaded)
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i python3.13t
          manylinux: ${{ matrix.manylinux || 'auto' }}
          sccache: true

      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-freethreaded-${{ matrix.target }}
          path: dist/*.whl

  sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist

      - name: Upload sdist
        uses: actions/upload-artifact@v6
        with:
          name: sdist
          path: dist/*.tar.gz
